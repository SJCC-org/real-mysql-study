# 4.1 MySQL 엔진 아키텍처

## 4.1.1 MySQL 의 전체 구조

### 4.1.1.1 MySQL 엔진

> 요청된 SQL 문장을 분석하거나 최적화 하는 등의 DBMS의 두뇌 역할

* `커넥션 핸들러`, `SQL 파서`, `전처리기`, `옵티마이저` 가 중심을 이룸
* 표준 SQL (ANSI SQL) 문법을 지원하기 때문에 표준 문법에 따라 작성된 쿼리는 타 DBMS와 호환 가능

### 4.1.1.2 스토리지 엔진

> 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분

```sql
CREATE TABLE test_table (fd1 INT, fd2 INT) ENGINE=INNODB; 
```

* MySQL 엔진은 하나지만 스토리지 엔진은 여러 개를 동시에 사용 가능
* 위 `test_table` 에 대해 `INSERT`, `UPDATE`, `DELETE`, `SELECT`, ... 등의 작업이 바생하면 `InnoDB` 스토리지 엔진이 그러한 처리를 담당
* 각 스토리지 엔진은 성능 향상을 위해 키 캣(MyISAM 스토리지 엔진), InnoDB 버퍼 풀(InnoDB 스토리지 엔진)과 같은 기능을 내장

### 4.1.1.3 핸들러 API

* MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때는 각 스토리지 엔진에 쓰기 또는 읽기를 요청하는데, 이러한 요청을 `핸들러(Handler)` 요청이라 함
* 이때 사용되는 API 를 `핸들러 API` 이라 함

```sql
SHOW GLOBAL STATUS LIKE 'Handler%';
-- 이 핸들러 API를 통해 얼마나 많은 데이터(레코드) 작업이 있었는지
```

## 4.1.2 MySQL 스레딩 구조

* MySQL 서버는 스레드 기반으로 작동 (프로세스 기반 X)
* 크게 포그라운드(foreground) 스레드와 백그라운드(Background) 스레드로 구분
* `performance_schema` 데이터베이스의 threads 테이블을 통해 확인 가능

```sql
SELECT thread_id, name, type, processlist_user, processlist_host
FROM performance_schema.threads ORDER BY type, thread_id;
```

### 4.1.2.1 포그라운드 스레드 (클라이언트 스레드)

* 최소 MySQL 서버에 접속된 클라이언트 수만큼 존재
* 주로 각 클라이언트가 요청하는 쿼리 문장 처리
* 커넥션이 종료되면 해당 커넥션을 담당하던 스레드는 다시 스레드 캐시(Thread cache)로 되돌아감
  * 이떄 이미 스레드 캐시에 일정 개수 이상의 대기중인 스레드가 있으면 스레드 캐시에 넣지 않고 스레드 캐시를 종료시켜 일정 개수의 스레드만 스레드 캐시에 존재하도록 함
  * 스레드 캐시에 유지할 수 있는 최대 스레드 개수는 `thread_cache_size` 시스템 변수로 설정

### 4.1.2.2 백그라운드 스레드

> MyISAM의 경우 별로 해당 사항이 없는 부분이지만 InnoDB는 다음과 같이 여러 가지 작업이 백그라운드로 처리됨

* 인서트 버퍼(Insert Buffer)를 병합하는 스레드
* 로그를 디스크로 기록하느 스레드
* InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
* 데이터를 버퍼로 읽어 오는 스레드
* 잠금이나 데드락을 모니터링하는 스레드

## 4.1.3 메모리 할당 및 사용 구조

### 4.1.3.1 글로벌 메모리 영역

> 일반적으로 클라이언트 스레드의 수와 무관하게 하나의 메모리 공간만 할당

* 테이블 캐시
* InnoDB 버퍼 풀
* InnoDB 어댑티브 해시 인덱스
* InnoDB 리두 로그 버퍼

### 4.1.3.2 로컬 메모리 영역

> MySQL 서버상에 존재하는 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 메모리 영역이며, 클라이언트 스레드별 독립적으로 할되고 공유되지 않음

* 정렬 버퍼 (Sort buffer)
* 조인 버퍼
* 바이너리 로그 캐시
* 네트워크 버퍼

로컬 메모리 공간은 각 쿼리의 용도별로 필요할 때만 공간이 할당되고 필요하지 않은 경우에는 MySQL이 메모리 공간을 할당조차도 하지 않을 수도 있다.

# 4.3 MyISAM 스토리지 엔진 아키텍처

## 4.3.1 키 캐시

- InnoDB의 버퍼 풀과 비슷한 역할
- 인덱스만을 대상으로 작동
- 인덱스의 디스크 쓰기 작업에 대해서만 부분적으로 버퍼링
- 키 캐시 히트율(Hit rate) = 100 - (Key_reads / Key_read_requests * 100)
  - Key_reads: 인덱스를 디스크에서 읽어 들인 횟수를 저장하는 상태 변수
  - Key_read_requests: 키 캐시로부터 인덱스를 읽은 횟수를 저장하는 상태 변수
  - 99% 이상으로 유지

```sql
-- Key_reads, Key_read_requests 상태변수 확인
SHOW GLOBAL STATUS LIKE 'Key%';
```

## 4.3.2 운영체제의 캐시 및 버퍼

- MyISAM 스토리지 엔진은 MyISAM 테이블의 데이터에 대해 디스크로부터 I/O를 해결해 줄 만한 어떠한 캐시나 버퍼링 기능도 가지고 있지 않음
  - 테이블의 데이터 읽기나 쓰기 작업은 항상 운영체제의 디스크 읽기 또는 쓰기 작업으로 요청
  - 대부분의 운영체제는 디스크로부터 읽고 쓰는 파일에 대한 캐시나 버퍼링 매커니즘이 탑재
- 운영체제의 캐시 공간은 남는 메모리를ㄹ 사용하는 것이 기본
  - 키 캐시는 최대 물리 메모리의 40% 이상을 넘지 않게 설정
  - 나머지 메모리 공간은 운영체제가 자체적인 파일 시스템을 위한 캐시공간을 마련할 수 있도록

## 4.3.3 데이터 파일과 프라이머리 키(인덱스) 구조

- MyISAM 테이블은 프라이머리 키에 의한 클러스터링 없이 데이터 파일이 힙(Heap) 공간 처럼 활용
  - MyISAM 테이블에 레코드는 프라이머리 키 값과 무관하게 INSERT되는 순서대로 데이터 파일에 저장
- MyISAM 테이블에 저장되는 레코드는 모두 `ROWID`라는 물리적인 주솟값을 가짐
- 프라이머리 키와 세컨더리 인덱스는 모두 데이터 파일에 저장된 레코드의 `ROWID` 값을 포인터로 가짐

### ROWID

#### 고정 길이 ROWID

- 자주 사용 X
- MyISAM 테이블을 생성할 때 MAX_ROWS 옵션을 명시하면 서버는 최대로 가질 수 있는 레코드가 한정된 테이블을 생성
- 4바이트 정수 ROWID 를 사용
- INSERT된 순번이 ROWID로 사용

#### 가변 길이 ROWID

- MyISAM 테이블을 생성할 때 MAX_ROWS 옵션을 설정하지 않으면 MyISAM 테이블의 ROWID는 최대 `myisam_data_pointer_size` 시스템 변수에 설정된 바이트 수 만큼의 공간 사용 가능
- `myisam_data_pointer_size` 기본값 7 -> 2 ~ 7 바이트까지의 가변적인 ROWID 저장
- 첫 번째 바이트는 ROWID 길이, 나머지 공간은 실제 ROWID

## 4.4 MySQL 로그 파일

### 4.4.1 에러 로그 파일

> MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일

- my.cnf에서 log_error 파라미터로 정의된 경로에 생성
- 별도로 정의되지 않은 경우 데이터 디렉터리(data_dir 파라미터에 설정된 디렉터리)에 생성
- .err 확장자가 붙은 파일로 생성

#### 4.4.1.1 MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지

MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후 다시시작하는 경우에는 반드시 MySQL 에러 로그 파일을 통해 설정된 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용됐는지 확인

#### 4.4.1.2 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지

InnoDB의 경우 MySQL 서버가 비정상적 또는 강제적으로 종료됐다면 다시 시작되면서 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리 작업을 하게 됨

#### 4.4.1.3 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지

쿼리 도중 발생하는 문제

#### 4.4.1.4 비정상적으로 종료된 커넥션 메시지(Aborted connection)

클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고 프로그램이 종료된 경우

#### 4.4.1.5 InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS 같은)의 결과 메시지

InnoDB의 테이블 모니터링이나 락모니터링, 또는 InnoDB의 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록하므로 InnoDB의 모니터링을 사용한 이후에는 다시 비활성화해서 에러 로그 파일이 커지지 않게 만들어야 한다.

#### 4.4.1.6 MySQL의 종료 메시지

MySQL 서버가 왜 종료됐는지 확인하는 유일한 방법

### 4.4.2 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)

- 쿼리 로그를 활성화 하면 쿼리를 쿼리 로그 파일로 기록하게됨
- 슬로우 쿼리 로그와는 조금 다르게 제너럴 쿼리 로그는 실행되기 전에 MySQL이 쿼리 요청을 받으면 바로 기록하기 때문에 쿼리 실행 중에 에러가 발생해도 일단 로그 파일에 기록
- `general_log_file`: 쿼리 로그 파일 경로
- `log_output`: 쿼리 로그를 파일로 저장할지 테이블로 저장할지
